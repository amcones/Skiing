using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;

public class Player : MonoBehaviour
{
    enum PlayerState
    {
        Sking,
        TouchBarrier,
        GameOver,
    }

    private static Player currentPlayer = null;
    public static Player CurrentPlayer => currentPlayer;

    public List<ISetPlayer> Setplayer;

    public string BarriersTag;
    public float SecondAfterBarrier;
    public int allowMistakeNumber;

    public UnityEvent mistakeEvent;
    public UnityEvent gameOverEvent;

    private PlayerMove playerMove;
    private PlayerState playerState;

    // Start is called before the first frame update
    void Start()
    {
        if (Setplayer == null)
            Setplayer = new List<ISetPlayer>();
        playerMove = GetComponent<PlayerMove>();
    }

    /// <summary>
    /// 添加设置玩家的类，初始化时调用
    /// </summary>
    /// <param name="setPlayer"></param>
    public void AddSet(ISetPlayer setPlayer)
    {
        Setplayer.Add(setPlayer);
    }

    /// <summary>
    /// 将玩家设置为当前的实例，初始化时调用
    /// </summary>
    public void SetPlayer()
    {
        currentPlayer = this;
        playerMove.enabled = true;
        
        foreach (var set in Setplayer)
        {
            set.SetPlayer(this.gameObject);
        }
    }

    /// <summary>
    /// 判断是否游戏结束
    /// </summary>
    /// <returns></returns>
    public bool IsGameOver()
    {
        return playerState == PlayerState.GameOver;
    }

    /// <summary>
    /// 判断是否碰撞到障碍物
    /// </summary>
    /// <returns></returns>
    public bool IsTouchBarrier()
    {
        return playerState == PlayerState.TouchBarrier;
    }

    /// <summary>
    /// 减少允许失误的次数
    /// </summary>
    public void DecreaseAllowMistakeNumber()
    {
        allowMistakeNumber--;
        if(allowMistakeNumber <= 0)
        {
            playerState = PlayerState.GameOver;
            gameOverEvent.Invoke();
        }
    }

    /// <summary>
    /// 玩家碰撞到障碍物运行的事件
    /// </summary>
    public void PlayerTouchbarrier()
    {
        playerState = PlayerState.TouchBarrier;
        //playerMove.TouchBarrier();
        DecreaseAllowMistakeNumber();
        mistakeEvent.Invoke();
    }

    /// <summary>
    /// 玩家重新开始滑冰
    /// </summary>
    public void PlayerReSking()
    {
        if (IsGameOver())
            return;

        playerState = PlayerState.Sking;
        playerMove.ResetState();
    }

    public void OnTriggerStay2D(Collider2D collision)
    {
        if (collision.gameObject.CompareTag(BarriersTag))
        {
            if (!IsGameOver() && !IsTouchBarrier())
            {
                StartCoroutine(WaitForContinueSking(SecondAfterBarrier));
            }
        }
    }

    private IEnumerator WaitForContinueSking(float seconds)
    {
        PlayerTouchbarrier();
        yield return new WaitForSeconds(seconds);
        PlayerReSking();
    }
}
